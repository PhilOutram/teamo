<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Fixtures - Next Weekend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .weekend-date {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .last-updated {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background: #2a5298;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1e3c72;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fixtures-grid {
            display: grid;
            gap: 20px;
        }
        
        .team-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .team-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .team-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
            font-size: 1.2em;
        }
        
        .team-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #1e3c72;
        }
        
        .fixture {
            padding: 15px;
            border-left: 4px solid #2a5298;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .fixture:last-child {
            margin-bottom: 0;
        }
        
        .fixture-date {
            font-weight: 600;
            color: #2a5298;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .fixture-time {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 8px;
        }
        
        .fixture-opponent {
            font-size: 1.1em;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .fixture-venue {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
        }
        
        .no-fixtures {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2e7d32;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèí Hockey Fixtures</h1>
            <div class="weekend-date" id="weekendDate"></div>
            <div class="last-updated" id="lastUpdated"></div>
        </header>
        
        <div class="controls">
            <div class="button-group">
                <button id="refreshBtn" onclick="loadFixtures()">üîÑ Refresh Fixtures</button>
            </div>
        </div>
        
        <div id="message"></div>
        <div id="content"></div>
    </div>

    <script>
        // Configuration - Update team names and icons
        // Feed files are fetched automatically by GitHub Actions
        const TEAMS = [
            { name: "Dad's Team", file: "feed1.ics", icon: "D" },
            { name: "Son 1's Team", file: "feed2.ics", icon: "S1" },
            { name: "Son 2's Team", file: "feed3.ics", icon: "S2" },
            { name: "Son 3's Team", file: "feed4.ics", icon: "S3" }
        ];

        let fixturesData = [];

        // Calculate next weekend (Saturday and Sunday)
        function getNextWeekend() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            // Days until next Saturday (6 = Saturday)
            let daysUntilSaturday;
            if (dayOfWeek === 0) { // Sunday
                daysUntilSaturday = 6;
            } else if (dayOfWeek === 6) { // Saturday - use today
                daysUntilSaturday = 0;
            } else { // Monday-Friday
                daysUntilSaturday = 6 - dayOfWeek;
            }
            
            const saturday = new Date(today);
            saturday.setDate(today.getDate() + daysUntilSaturday);
            saturday.setHours(0, 0, 0, 0);
            
            const sunday = new Date(saturday);
            sunday.setDate(saturday.getDate() + 1);
            
            const mondayMorning = new Date(sunday);
            mondayMorning.setDate(sunday.getDate() + 1);
            
            return { saturday, sunday, mondayMorning };
        }

        // Format date for display
        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-GB', options);
        }

        // Format time for display
        function formatTime(date) {
            return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        }

        // Parse iCal data
        function parseICS(icsText) {
            const events = [];
            const lines = icsText.split('\n').map(line => line.trim());
            
            let currentEvent = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.dtstart) {
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    if (line.startsWith('DTSTART')) {
                        const dateStr = line.split(':')[1];
                        currentEvent.dtstart = parseICSDate(dateStr);
                    } else if (line.startsWith('SUMMARY:')) {
                        currentEvent.summary = line.substring(8);
                    } else if (line.startsWith('LOCATION:')) {
                        currentEvent.location = line.substring(9);
                    } else if (line.startsWith('DESCRIPTION:')) {
                        currentEvent.description = line.substring(12);
                    }
                }
            }
            
            return events;
        }

        // Parse ICS date format
        function parseICSDate(dateStr) {
            // Format: YYYYMMDDTHHMMSS or YYYYMMDD
            dateStr = dateStr.replace(/[Z]/g, '');
            
            const year = parseInt(dateStr.substring(0, 4));
            const month = parseInt(dateStr.substring(4, 6)) - 1;
            const day = parseInt(dateStr.substring(6, 8));
            
            if (dateStr.length > 8) {
                const hour = parseInt(dateStr.substring(9, 11));
                const minute = parseInt(dateStr.substring(11, 13));
                return new Date(year, month, day, hour, minute);
            }
            
            return new Date(year, month, day);
        }

        // Extract opponent from summary
        function extractOpponent(summary, teamName) {
            // Common patterns: "Team A vs Team B", "Team A v Team B", "vs Team B"
            const patterns = [
                /vs\.?\s+(.+?)$/i,
                /v\s+(.+?)$/i,
                /-\s*(.+?)$/,
                /against\s+(.+?)$/i
            ];
            
            for (const pattern of patterns) {
                const match = summary.match(pattern);
                if (match) {
                    return match[1].trim();
                }
            }
            
            return summary;
        }

        // Load last updated timestamp
        async function loadLastUpdated() {
            try {
                const response = await fetch('last_updated.txt');
                if (response.ok) {
                    const text = await response.text();
                    const date = new Date(text.trim());
                    document.getElementById('lastUpdated').textContent = 
                        `Last updated: ${date.toLocaleString('en-GB')}`;
                }
            } catch (error) {
                console.log('Could not load last updated time');
            }
        }

        // Load fixtures from all teams
        async function loadFixtures() {
            const contentDiv = document.getElementById('content');
            const messageDiv = document.getElementById('message');
            const refreshBtn = document.getElementById('refreshBtn');
            
            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading fixtures...</p></div>';
            messageDiv.innerHTML = '';
            refreshBtn.disabled = true;
            
            const weekend = getNextWeekend();
            document.getElementById('weekendDate').textContent = 
                `${formatDate(weekend.saturday)} - ${formatDate(weekend.sunday)}`;
            
            await loadLastUpdated();
            
            fixturesData = [];
            
            try {
                for (const team of TEAMS) {
                    try {
                        const response = await fetch(team.file);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const icsText = await response.text();
                        const events = parseICS(icsText);
                        
                        // Filter for next weekend
                        const weekendEvents = events.filter(event => {
                            return event.dtstart >= weekend.saturday && 
                                   event.dtstart < weekend.mondayMorning;
                        });
                        
                        // Sort by date/time
                        weekendEvents.sort((a, b) => a.dtstart - b.dtstart);
                        
                        fixturesData.push({
                            team: team,
                            fixtures: weekendEvents
                        });
                    } catch (error) {
                        console.error(`Error loading fixtures for ${team.name}:`, error);
                        fixturesData.push({
                            team: team,
                            fixtures: [],
                            error: error.message
                        });
                    }
                }
                
                displayFixtures();
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">Error loading fixtures: ${error.message}</div>`;
                contentDiv.innerHTML = '';
            } finally {
                refreshBtn.disabled = false;
            }
        }

        // Display fixtures
        function displayFixtures() {
            const contentDiv = document.getElementById('content');
            const messageDiv = document.getElementById('message');
            
            let html = '<div class="fixtures-grid">';
            let totalFixtures = 0;
            
            for (const teamData of fixturesData) {
                html += `
                    <div class="team-section">
                        <div class="team-header">
                            <div class="team-icon">${teamData.team.icon}</div>
                            <div class="team-name">${teamData.team.name}</div>
                        </div>
                `;
                
                if (teamData.error) {
                    html += `<div class="no-fixtures">‚ö†Ô∏è Error loading fixtures: ${teamData.error}</div>`;
                } else if (teamData.fixtures.length === 0) {
                    html += '<div class="no-fixtures">No fixtures this weekend</div>';
                } else {
                    totalFixtures += teamData.fixtures.length;
                    
                    for (const fixture of teamData.fixtures) {
                        const opponent = extractOpponent(fixture.summary, teamData.team.name);
                        
                        html += `
                            <div class="fixture">
                                <div class="fixture-date">${formatDate(fixture.dtstart)}</div>
                                <div class="fixture-time">‚è∞ ${formatTime(fixture.dtstart)}</div>
                                <div class="fixture-opponent">üèí ${opponent}</div>
                                ${fixture.location ? `<div class="fixture-venue">üìç ${fixture.location}</div>` : ''}
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            contentDiv.innerHTML = html;
            
            if (totalFixtures === 0) {
                messageDiv.innerHTML = '<div class="success">‚úÖ All fixtures loaded - no games this weekend!</div>';
            } else {
                messageDiv.innerHTML = `<div class="success">‚úÖ Loaded ${totalFixtures} fixture${totalFixtures !== 1 ? 's' : ''}</div>`;
            }
        }

        // Load fixtures on page load
        window.addEventListener('load', loadFixtures);
    </script>
</body>
</html>
